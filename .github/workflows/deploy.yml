# DailyMeal ìë™ ë°°í¬ ì›Œí¬í”Œë¡œìš°
name: DailyMeal CI/CD Pipeline

# íŠ¸ë¦¬ê±° ì¡°ê±´
on:
  push:
    branches: [ dev, prod ] # dev(ìŠ¤í…Œì´ì§•), prod(ìš´ì˜) ë¸Œëœì¹˜ ë°°í¬
  pull_request:
    branches: [ main, dev ] # main, devë¡œì˜ PR ì‹œ í…ŒìŠ¤íŠ¸ ì‹¤í–‰

jobs:
  # PR í…ŒìŠ¤íŠ¸ (main ë˜ëŠ” devë¡œì˜ PRì¼ ë•Œ)
  test:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-22.04
    
    steps:
    - name: ğŸ“¥ Checkout source code
      uses: actions/checkout@v4
      
    - name: âš™ï¸ Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: ğŸ§ª Run tests
      run: |
        # ë°±ì—”ë“œ í…ŒìŠ¤íŠ¸
        cd backend && npm install && npm run test
        # í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ í…ŒìŠ¤íŠ¸
        cd ../frontend && npm install && npm run build:hybrid
      env:
        NEXT_PUBLIC_API_URL: /api
        NEXT_PUBLIC_SITE_URL: http://localhost

  # ğŸ”§ Staging í™˜ê²½ ë°°í¬ (dev ë¸Œëœì¹˜ â†’ ìŠ¤í…Œì´ì§• ì„œë²„)
  deploy-staging:
    if: github.ref == 'refs/heads/dev'
    runs-on: ubuntu-22.04
    environment: staging
    
    steps:
    - name: ğŸ“¥ Checkout source code
      uses: actions/checkout@v4
      
    - name: âš™ï¸ Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: ğŸ”§ Build backend (Staging)
      run: |
        cd backend && npm ci && npm run build
        
    - name: ğŸ¨ Build frontend (Staging)  
      run: |
        cd frontend && npm ci && npm run build:hybrid
      env:
        NEXT_PUBLIC_API_URL: /api
        NEXT_PUBLIC_SITE_URL: ${{ vars.STAGING_DOMAIN_URL || 'http://dev.localhost' }}
        
    - name: ğŸš€ Deploy to Staging Server
      uses: easingthemes/ssh-deploy@main
      with:
        SSH_PRIVATE_KEY: ${{ secrets.EC2_PRIVATE_KEY }}
        REMOTE_HOST: ${{ vars.EC2_HOST }}
        REMOTE_USER: ${{ vars.EC2_USERNAME }}
        SOURCE: "./"
        TARGET: "/home/ubuntu/DailyMeal"
        EXCLUDE: "/node_modules/, /.git/, /deprecated/, /dailymeal-deploy-key*"
        
    - name: âš¡ Restart Staging Services
      uses: appleboy/ssh-action@master
      with:
        host: ${{ vars.EC2_HOST }}
        username: ${{ vars.EC2_USERNAME }}
        key: ${{ secrets.EC2_PRIVATE_KEY }}
        script: |
          cd /home/ubuntu/DailyMeal
          export BACKEND_PORT=8001
          export FRONTEND_PORT=8000
          npm ci --prefix ./backend
          npm ci --prefix ./frontend
          chmod +x deploy.sh && ./deploy.sh
          
          # Staging í—¬ìŠ¤ ì²´í¬
          sleep 5
          curl -f http://localhost:8000/api-docs || exit 1
          curl -f http://localhost:3000 || exit 1
          echo "âœ… Staging ë°°í¬ ì™„ë£Œ!"

  # ğŸš€ í”„ë¡œë•ì…˜ í™˜ê²½ ë°°í¬ (prod ë¸Œëœì¹˜ â†’ ìš´ì˜ ì„œë²„)
  deploy-production:
    if: github.ref == 'refs/heads/prod'
    runs-on: ubuntu-22.04
    environment: production
    
    steps:
    - name: ğŸ“¥ Checkout source code
      uses: actions/checkout@v4

    - name: âš™ï¸ Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20' # LTS ë²„ì „ (ì•ˆì •ì„± ìš°ì„ )
        cache: 'npm'
        
    - name: ğŸ”§ Build backend (Production)
      run: |
        cd backend && npm ci && npm run build
        
    - name: ğŸ¨ Build frontend (Production)
      run: |
        cd frontend && npm ci && npm run build:hybrid
      env:
        NEXT_PUBLIC_API_URL: /api
        NEXT_PUBLIC_SITE_URL: ${{ vars.DOMAIN_URL || 'http://localhost' }}
        
    - name: ğŸš€ Deploy to Production Server
      uses: easingthemes/ssh-deploy@main
      with:
        SSH_PRIVATE_KEY: ${{ secrets.EC2_PRIVATE_KEY }}
        REMOTE_HOST: ${{ vars.EC2_HOST }}
        REMOTE_USER: ${{ vars.EC2_USERNAME }}
        SOURCE: "./"
        TARGET: "/home/ubuntu/DailyMeal"
        EXCLUDE: "/node_modules/, /.git/, /deprecated/, /dailymeal-deploy-key*"
        SCRIPT_BEFORE: |
          # ë°°í¬ ì „ ë°±ì—…
          if [ -d "/home/ubuntu/DailyMeal-backup" ]; then
            rm -rf /home/ubuntu/DailyMeal-backup
          fi
          if [ -d "/home/ubuntu/DailyMeal" ]; then
            mv /home/ubuntu/DailyMeal /home/ubuntu/DailyMeal-backup
          fi
          
    - name: âš¡ Restart Production Services
      uses: appleboy/ssh-action@master
      with:
        host: ${{ vars.EC2_HOST }}
        username: ${{ vars.EC2_USERNAME }}
        key: ${{ secrets.EC2_PRIVATE_KEY }}
        script: |
          cd /home/ubuntu/DailyMeal
          
          # ì˜ì¡´ì„± ì„¤ì¹˜ (í”„ë¡œë•ì…˜ìš©) - ë¹Œë“œ ë„êµ¬ í¬í•¨
          npm ci --prefix ./backend
          npm ci --prefix ./frontend
          
          # PM2 ì„œë¹„ìŠ¤ ì¬ì‹œì‘
          export BACKEND_PORT=8000
          export FRONTEND_PORT=3000
          chmod +x deploy.sh && ./deploy.sh
          
          # Nginx ì„¤ì • í™•ì¸ ë° ì¬ë¡œë“œ
          if [ -f "/etc/nginx/sites-available/dailymeal" ]; then
            sudo nginx -t && sudo systemctl reload nginx
          fi
          
          # í”„ë¡œë•ì…˜ í—¬ìŠ¤ ì²´í¬
          sleep 5
          curl -f http://localhost:8000/api-docs || exit 1
          curl -f http://localhost:3000 || exit 1
          echo "âœ… í”„ë¡œë•ì…˜ ë°°í¬ ì™„ë£Œ!"
        
