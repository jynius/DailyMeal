# DailyMeal ìë™ ë°°í¬ ì›Œí¬í”Œë¡œìš°
name: DailyMeal CI/CD Pipeline

# ê¶Œí•œ ì„¤ì • (ë³´ì•ˆ ê°•í™”)
permissions:
  contents: read
  actions: read
  security-events: write

# íŠ¸ë¦¬ê±° ì¡°ê±´
on:
  push:
    branches: [ dev, prod ] # dev(ìŠ¤í…Œì´ì§•), prod(ìš´ì˜) ë¸Œëœì¹˜ ë°°í¬
  pull_request:
    branches: [ main, dev ] # main, devë¡œì˜ PR ì‹œ í…ŒìŠ¤íŠ¸ ì‹¤í–‰

jobs:
  # PR í…ŒìŠ¤íŠ¸ (main ë˜ëŠ” devë¡œì˜ PRì¼ ë•Œ)
  test:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-22.04
    
    steps:
    - name: ğŸ“¥ Checkout source code
      uses: actions/checkout@v4
      
    - name: âš™ï¸ Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: |
          backend/package-lock.json
          frontend/package-lock.json
        
    - name: ğŸ§ª Run tests
      run: |
        # ë°±ì—”ë“œ í…ŒìŠ¤íŠ¸
        cd backend && npm install && npm run test
        # í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ í…ŒìŠ¤íŠ¸
        cd ../frontend && npm install && npm run build:hybrid
      env:
        NEXT_PUBLIC_API_URL: /api
        NEXT_PUBLIC_SITE_URL: http://localhost

  # ğŸ”§ Staging í™˜ê²½ ë°°í¬ (dev ë¸Œëœì¹˜ â†’ ìŠ¤í…Œì´ì§• ì„œë²„)
  deploy-staging:
    if: github.ref == 'refs/heads/dev'
    runs-on: ubuntu-22.04
    environment: staging
    
    steps:
    - name: ğŸ“¥ Checkout source code
      uses: actions/checkout@v4
      
    - name: âš™ï¸ Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: ğŸ”§ Build backend (Staging)
      run: |
        cd backend && npm ci && npm run build
        
    - name: ğŸ¨ Build frontend (Staging)  
      run: |
        cd frontend && npm ci && npm run build:hybrid
      env:
        NEXT_PUBLIC_API_URL: /api
        NEXT_PUBLIC_SITE_URL: https://dev-dailymeal.example.com
        
    - name: ğŸš€ Deploy to Staging Server
      uses: easingthemes/ssh-deploy@v2.2.11
      with:
        SSH_PRIVATE_KEY: ${{ secrets.EC2_PRIVATE_KEY }}
        REMOTE_HOST: ${{ vars.EC2_HOST }}
        REMOTE_USER: ${{ vars.EC2_USERNAME }}
        SOURCE: "./"
        TARGET: "/home/ubuntu/DailyMeal"
        EXCLUDE: "/node_modules/, /.git/, /deprecated/, /dailymeal-deploy-key*"
        
    - name: âš¡ Restart Staging Services
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ vars.EC2_HOST }}
        username: ${{ vars.EC2_USERNAME }}
        key: ${{ secrets.EC2_PRIVATE_KEY }}
        script: |
          cd /home/ubuntu/DailyMeal
          
          # ğŸ“Š ë°°í¬ ì‹œì‘ ë¦¬ì†ŒìŠ¤ ì¸¡ì •
          echo "ğŸš€ [$(date)] ìŠ¤í…Œì´ì§• ë°°í¬ ì‹œì‘ - ë¦¬ì†ŒìŠ¤ ì¸¡ì • ì¤‘..."
          echo "ğŸ“Š ì´ˆê¸° ì‹œìŠ¤í…œ ìƒíƒœ:"
          echo "ğŸ’¾ ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥ : $(free -h | awk '/^Mem:/ {print $3 "/" $2 " (" int($3/$2 * 100) "%)"}')"
          echo "ğŸ’½ ë””ìŠ¤í¬ ì‚¬ìš©ë¥ : $(df -h / | awk 'NR==2{print $3 "/" $2 " (" $5 ")"}')"
          echo "âš¡ CPU ë¶€í•˜: $(uptime | awk -F'load average:' '{ print $2 }')"
          
          # í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (ë¦¬ì†ŒìŠ¤ ì ˆì•½)
          export BACKEND_PORT=8001
          export FRONTEND_PORT=8000
          export NODE_ENV=staging
          export NODE_OPTIONS="--max-old-space-size=512"  # ë©”ëª¨ë¦¬ ì œí•œ 512MB
          
          # ğŸ”§ ì˜ì¡´ì„± ì„¤ì¹˜ (í”„ë¡œë•ì…˜ ì „ìš©, ìºì‹œ í™œìš©)
          echo "ğŸ“¦ [$(date)] ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘ (ìºì‹œ ìš°ì„ )..."
          npm ci --prefix ./backend --only=production --prefer-offline --no-audit
          npm ci --prefix ./frontend --only=production --prefer-offline --no-audit
          
          # ğŸ§¹ ì´ì „ í”„ë¡œì„¸ìŠ¤ ì •ë¦¬
          echo "ğŸ§¹ [$(date)] ì´ì „ í”„ë¡œì„¸ìŠ¤ ì •ë¦¬ ì¤‘..."
          pkill -f "node.*backend" || true
          pkill -f "next.*frontend" || true
          sleep 2
          
          # ğŸ“Š ë°°í¬ ì¤‘ ë¦¬ì†ŒìŠ¤ ì¸¡ì •
          echo "ğŸ“Š ì˜ì¡´ì„± ì„¤ì¹˜ í›„ ë¦¬ì†ŒìŠ¤ ìƒíƒœ:"
          echo "ğŸ’¾ ë©”ëª¨ë¦¬: $(free -h | awk '/^Mem:/ {print $3 "/" $2 " (" int($3/$2 * 100) "%)"}')"
          echo "ğŸ’½ ë””ìŠ¤í¬: $(df -h / | awk 'NR==2{print $3 "/" $2 " (" $5 ")"}')"
          
          # ğŸš€ ì„œë¹„ìŠ¤ ì‹œì‘
          chmod +x deploy.sh && ./deploy.sh
          
          # ğŸ“Š ì„œë¹„ìŠ¤ ì‹œì‘ í›„ ë¦¬ì†ŒìŠ¤ ëª¨ë‹ˆí„°ë§
          echo "â³ [$(date)] ì„œë¹„ìŠ¤ ì‹œì‘ ëŒ€ê¸° ë° ëª¨ë‹ˆí„°ë§..."
          sleep 10
          
          echo "ğŸ“Š ì„œë¹„ìŠ¤ ì‹œì‘ í›„ ë¦¬ì†ŒìŠ¤ ìƒíƒœ:"
          echo "ğŸ’¾ ë©”ëª¨ë¦¬: $(free -h | awk '/^Mem:/ {print $3 "/" $2 " (" int($3/$2 * 100) "%)"}')"
          echo "ğŸ’½ ë””ìŠ¤í¬: $(df -h / | awk 'NR==2{print $3 "/" $2 " (" $5 ")"}')"
          echo "ğŸ”„ Node í”„ë¡œì„¸ìŠ¤: $(ps aux | grep -E "node.*backend|next.*frontend" | grep -v grep | wc -l)ê°œ"
          
          # ğŸ¥ ë°±ì—”ë“œ í—¬ìŠ¤ ì²´í¬ (ì„±ëŠ¥ ì¸¡ì • í¬í•¨)
          for i in {1..3}; do
            echo "ğŸ” ë°±ì—”ë“œ ì²´í¬ $i/3..."
            START_TIME=$(date +%s%N)
            if curl -f -s http://localhost:8001/api-docs > /dev/null; then
              END_TIME=$(date +%s%N)
              RESPONSE_TIME=$(( (END_TIME - START_TIME) / 1000000 ))
              echo "âœ… ë°±ì—”ë“œ ì„œë¹„ìŠ¤ ì •ìƒ (ì‘ë‹µì‹œê°„: ${RESPONSE_TIME}ms)"
              break
            elif [ $i -eq 3 ]; then
              echo "âŒ ë°±ì—”ë“œ ì„œë¹„ìŠ¤ ì‹œì‘ ì‹¤íŒ¨"
              echo "ğŸ” í”„ë¡œì„¸ìŠ¤ ìƒíƒœ: $(ps aux | grep -E "node.*backend" | grep -v grep)"
              echo "ğŸ“‹ ë°±ì—”ë“œ ë¡œê·¸: $(tail -n 5 ./backend/logs/error.log 2>/dev/null || echo 'ë¡œê·¸ ì—†ìŒ')"
              exit 1
            else
              echo "â³ ë°±ì—”ë“œ ì¬ì‹œë„ $i/3... (5ì´ˆ ëŒ€ê¸°)"
              sleep 5
            fi
          done
          
          # ğŸ¥ í”„ë¡ íŠ¸ì—”ë“œ í—¬ìŠ¤ ì²´í¬ (ì„±ëŠ¥ ì¸¡ì • í¬í•¨)
          for i in {1..3}; do
            echo "ğŸ” í”„ë¡ íŠ¸ì—”ë“œ ì²´í¬ $i/3..."
            START_TIME=$(date +%s%N)
            if curl -f -s http://localhost:8000 > /dev/null; then
              END_TIME=$(date +%s%N)
              RESPONSE_TIME=$(( (END_TIME - START_TIME) / 1000000 ))
              echo "âœ… í”„ë¡ íŠ¸ì—”ë“œ ì„œë¹„ìŠ¤ ì •ìƒ (ì‘ë‹µì‹œê°„: ${RESPONSE_TIME}ms)"
              break
            elif [ $i -eq 3 ]; then
              echo "âŒ í”„ë¡ íŠ¸ì—”ë“œ ì„œë¹„ìŠ¤ ì‹œì‘ ì‹¤íŒ¨"
              echo "ğŸ” í”„ë¡œì„¸ìŠ¤ ìƒíƒœ: $(ps aux | grep -E "next.*frontend" | grep -v grep)"
              exit 1
            else
              echo "â³ í”„ë¡ íŠ¸ì—”ë“œ ì¬ì‹œë„ $i/3... (5ì´ˆ ëŒ€ê¸°)"
              sleep 5
            fi
          done
          
          # ğŸ“Š ìµœì¢… ë¦¬ì†ŒìŠ¤ ìƒíƒœ ë¡œê¹…
          echo "=========================================="
          echo "ğŸ‰ [$(date)] Staging ë°°í¬ ì™„ë£Œ!"
          echo "ğŸ“Š ìµœì¢… ì‹œìŠ¤í…œ ìƒíƒœ:"
          echo "ğŸ’¾ ë©”ëª¨ë¦¬: $(free -h | awk '/^Mem:/ {print $3 "/" $2 " (" int($3/$2 * 100) "%)"}')"
          echo "ğŸ’½ ë””ìŠ¤í¬: $(df -h / | awk 'NR==2{print $3 "/" $2 " (" $5 ")"}')"
          echo "âš¡ CPU: $(top -bn1 | grep "Cpu(s)" | awk '{print $2 + $4}')% ì‚¬ìš©ì¤‘"
          echo "ğŸ”„ í™œì„± í”„ë¡œì„¸ìŠ¤: $(ps aux | grep -E "node|next" | grep -v grep | wc -l)ê°œ"
          echo "=========================================="

  # ğŸš€ í”„ë¡œë•ì…˜ í™˜ê²½ ë°°í¬ (prod ë¸Œëœì¹˜ â†’ ìš´ì˜ ì„œë²„)
  deploy-production:
    if: github.ref == 'refs/heads/prod'
    runs-on: ubuntu-22.04

    steps:
    - name: ğŸ“¥ Checkout source code
      uses: actions/checkout@v4

    - name: âš™ï¸ Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20' # LTS ë²„ì „ (ì•ˆì •ì„± ìš°ì„ )
        cache: 'npm'
        
    - name: ğŸ”§ Build backend (Production)
      run: |
        cd backend && npm ci && npm run build
        
    - name: ğŸ¨ Build frontend (Production)
      run: |
        cd frontend && npm ci && npm run build:hybrid
      env:
        NEXT_PUBLIC_API_URL: /api
        NEXT_PUBLIC_SITE_URL: https://dailymeal.example.com
        
    - name: ğŸš€ Deploy to Production Server
      uses: easingthemes/ssh-deploy@v2.2.11
      with:
        SSH_PRIVATE_KEY: ${{ secrets.EC2_PRIVATE_KEY }}
        REMOTE_HOST: ${{ vars.EC2_HOST }}
        REMOTE_USER: ${{ vars.EC2_USERNAME }}
        SOURCE: "./"
        TARGET: "/home/ubuntu/DailyMeal"
        EXCLUDE: "/node_modules/, /.git/, /deprecated/, /dailymeal-deploy-key*"

    - name: âš¡ Restart Production Services
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ vars.EC2_HOST }}
        username: ${{ vars.EC2_USERNAME }}
        key: ${{ secrets.EC2_PRIVATE_KEY }}
        script: |
          # ğŸ“Š ë°°í¬ ì‹œì‘ ì‹œìŠ¤í…œ ìƒíƒœ ë¡œê¹…
          echo "ğŸš€ [$(date)] í”„ë¡œë•ì…˜ ë°°í¬ ì‹œì‘"
          echo "=========================================="
          
          # ğŸ“Š ì‹œìŠ¤í…œ ë¦¬ì†ŒìŠ¤ ì¸¡ì • í•¨ìˆ˜
          log_resources() {
            local stage="$1"
            echo "ğŸ“Š [$stage] ì‹œìŠ¤í…œ ìƒíƒœ ($(date)):"
            echo "  ğŸ’¾ ë©”ëª¨ë¦¬: $(free -h | awk '/^Mem:/ {print "ì‚¬ìš©=" $3 " ì „ì²´=" $2 " (" int($3/$2 * 100) "%)"}')"
            echo "  ğŸ’½ ë””ìŠ¤í¬: $(df -h / | awk 'NR==2{print "ì‚¬ìš©=" $3 " ì „ì²´=" $2 " (" $5 ")"}')"
            echo "  âš¡ CPU: $(top -bn1 | grep "Cpu(s)" | awk '{print $2 + $4}')% ì‚¬ìš©ì¤‘"
            echo "  ğŸ“ˆ ë¶€í•˜: $(uptime | awk -F'load average:' '{print $2}')"
            echo "  ğŸ”„ í”„ë¡œì„¸ìŠ¤: $(ps aux | grep -E "(node|npm)" | grep -v grep | wc -l)ê°œ Node.js í”„ë¡œì„¸ìŠ¤"
          }
          
          log_resources "ë°°í¬ ì‹œì‘"
          
          # ë°°í¬ ì „ ë°±ì—… (ê³µê°„ í™•ì¸ í›„)
          echo "ğŸ’¾ [$(date)] ë°±ì—… ê³µê°„ í™•ì¸ ì¤‘..."
          AVAILABLE_SPACE=$(df / | awk 'NR==2{print $4}')
          REQUIRED_SPACE=$(du -s /home/ubuntu/DailyMeal 2>/dev/null | awk '{print $1}' || echo "1000000")
          
          if [ "$AVAILABLE_SPACE" -gt "$((REQUIRED_SPACE * 2))" ]; then
            echo "âœ… ì¶©ë¶„í•œ ê³µê°„ í™•ì¸ - ë°±ì—… ì§„í–‰"
            if [ -d "/home/ubuntu/DailyMeal-backup" ]; then
              rm -rf /home/ubuntu/DailyMeal-backup
            fi
            if [ -d "/home/ubuntu/DailyMeal" ]; then
              cp -r /home/ubuntu/DailyMeal /home/ubuntu/DailyMeal-backup
            fi
          else
            echo "âš ï¸ ë””ìŠ¤í¬ ê³µê°„ ë¶€ì¡± - ë°±ì—… ìƒëµ (ê°€ìš©: ${AVAILABLE_SPACE}KB, í•„ìš”: ${REQUIRED_SPACE}KB)"
          fi
          
          cd /home/ubuntu/DailyMeal
          
          # í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (ì„±ëŠ¥ ìµœì í™”)
          export BACKEND_PORT=8000
          export FRONTEND_PORT=3000
          export NODE_ENV=production
          export NODE_OPTIONS="--max-old-space-size=1024 --optimize-for-size"  # ë©”ëª¨ë¦¬ ì œí•œ 1GB
          
          # ğŸ§¹ ì´ì „ í”„ë¡œì„¸ìŠ¤ ì •ë¦¬ (ë©”ëª¨ë¦¬ í•´ì œ)
          echo "ğŸ§¹ [$(date)] ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì •ë¦¬ ì¤‘..."
          pm2 stop all 2>/dev/null || true
          pm2 delete all 2>/dev/null || true
          pkill -f "node.*backend" || true
          pkill -f "next.*frontend" || true
          sleep 3
          
          log_resources "í”„ë¡œì„¸ìŠ¤ ì •ë¦¬ í›„"
          
          # ğŸ”§ ì˜ì¡´ì„± ì„¤ì¹˜ (ìµœì í™”ëœ ì„¤ì •)
          echo "ğŸ“¦ [$(date)] ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘ (í”„ë¡œë•ì…˜ ìµœì í™”)..."
          
          # ë³‘ë ¬ ì„¤ì¹˜ ëŒ€ì‹  ìˆœì°¨ ì„¤ì¹˜ (ë©”ëª¨ë¦¬ ì ˆì•½)
          echo "  ğŸ”§ ë°±ì—”ë“œ ì˜ì¡´ì„±..."
          npm ci --prefix ./backend --only=production --prefer-offline --no-audit --silent
          
          log_resources "ë°±ì—”ë“œ ì„¤ì¹˜ í›„"
          
          echo "  ğŸ¨ í”„ë¡ íŠ¸ì—”ë“œ ì˜ì¡´ì„±..."
          npm ci --prefix ./frontend --only=production --prefer-offline --no-audit --silent
          
          log_resources "ì˜ì¡´ì„± ì„¤ì¹˜ ì™„ë£Œ"
          
          # ğŸš€ ì„œë¹„ìŠ¤ ì‹œì‘ (ë¦¬ì†ŒìŠ¤ ëª¨ë‹ˆí„°ë§ í¬í•¨)
          echo "ğŸš€ [$(date)] ì„œë¹„ìŠ¤ ì‹œì‘ ì¤‘..."
          chmod +x deploy.sh && ./deploy.sh
          
          # Nginx ì„¤ì • í™•ì¸ ë° ì¬ë¡œë“œ
          if [ -f "/etc/nginx/sites-available/dailymeal" ]; then
            sudo nginx -t && sudo systemctl reload nginx
          fi
          
          # ğŸ“Š í”„ë¡œë•ì…˜ í—¬ìŠ¤ ì²´í¬ (ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ í¬í•¨)
          echo "â³ [$(date)] í”„ë¡œë•ì…˜ ì„œë¹„ìŠ¤ ì‹œì‘ ëŒ€ê¸° ë° ëª¨ë‹ˆí„°ë§..."
          sleep 15
          
          log_resources "ì„œë¹„ìŠ¤ ì‹œì‘ í›„"
          
          # ğŸ¥ ë°±ì—”ë“œ í—¬ìŠ¤ ì²´í¬ (ì„±ëŠ¥ ì¸¡ì • í¬í•¨)
          BACKEND_SUCCESS=false
          for i in {1..5}; do
            echo "ğŸ” [í”„ë¡œë•ì…˜] ë°±ì—”ë“œ ì²´í¬ $i/5..."
            START_TIME=$(date +%s%N)
            
            if curl -f -s --max-time 10 http://localhost:8000/api-docs > /dev/null; then
              END_TIME=$(date +%s%N)
              RESPONSE_TIME=$(( (END_TIME - START_TIME) / 1000000 ))
              echo "âœ… ë°±ì—”ë“œ ì„œë¹„ìŠ¤ ì •ìƒ (ì‘ë‹µì‹œê°„: ${RESPONSE_TIME}ms)"
              
              # ì¶”ê°€ ì„±ëŠ¥ ì²´í¬
              MEMORY_USAGE=$(ps -o pid,vsz,rss,comm -p $(pgrep -f "node.*backend") 2>/dev/null | awk 'NR>1{print "PID=" $1 " ë©”ëª¨ë¦¬=" int($3/1024) "MB"}' || echo "í”„ë¡œì„¸ìŠ¤ ì •ë³´ ì—†ìŒ")
              echo "ğŸ“Š ë°±ì—”ë“œ í”„ë¡œì„¸ìŠ¤: $MEMORY_USAGE"
              
              BACKEND_SUCCESS=true
              break
            elif [ $i -eq 5 ]; then
              echo "âŒ ë°±ì—”ë“œ ì„œë¹„ìŠ¤ ì‹œì‘ ì‹¤íŒ¨ - ë¡¤ë°± ì‹œì‘"
              echo "ğŸ“‹ ì˜¤ë¥˜ ë¡œê·¸: $(tail -n 10 ./backend/logs/error.log 2>/dev/null || echo 'ë¡œê·¸ íŒŒì¼ ì—†ìŒ')"
              echo "ğŸ” í”„ë¡œì„¸ìŠ¤ ìƒíƒœ: $(ps aux | grep -E "node.*backend" | grep -v grep || echo 'í”„ë¡œì„¸ìŠ¤ ì—†ìŒ')"
              
              # ë°±ì—…ì—ì„œ ë³µêµ¬
              if [ -d "/home/ubuntu/DailyMeal-backup" ]; then
                echo "ğŸ”„ [$(date)] ì´ì „ ë²„ì „ìœ¼ë¡œ ë¡¤ë°± ì¤‘..."
                mv /home/ubuntu/DailyMeal /home/ubuntu/DailyMeal-failed
                mv /home/ubuntu/DailyMeal-backup /home/ubuntu/DailyMeal
                cd /home/ubuntu/DailyMeal
                chmod +x deploy.sh && ./deploy.sh
                echo "âœ… ë¡¤ë°± ì™„ë£Œ"
              fi
              exit 1
            else
              echo "â³ ë°±ì—”ë“œ ì¬ì‹œë„ $i/5... (10ì´ˆ ëŒ€ê¸°)"
              log_resources "ì¬ì‹œë„ $i"
              sleep 10
            fi
          done
          
          # ğŸ¥ í”„ë¡ íŠ¸ì—”ë“œ í—¬ìŠ¤ ì²´í¬ (ì„±ëŠ¥ ì¸¡ì • í¬í•¨)
          if [ "$BACKEND_SUCCESS" = true ]; then
            for i in {1..5}; do
              echo "ğŸ” [í”„ë¡œë•ì…˜] í”„ë¡ íŠ¸ì—”ë“œ ì²´í¬ $i/5..."
              START_TIME=$(date +%s%N)
              
              if curl -f -s --max-time 10 http://localhost:3000 > /dev/null; then
                END_TIME=$(date +%s%N)
                RESPONSE_TIME=$(( (END_TIME - START_TIME) / 1000000 ))
                echo "âœ… í”„ë¡ íŠ¸ì—”ë“œ ì„œë¹„ìŠ¤ ì •ìƒ (ì‘ë‹µì‹œê°„: ${RESPONSE_TIME}ms)"
                
                # ì¶”ê°€ ì„±ëŠ¥ ì²´í¬
                MEMORY_USAGE=$(ps -o pid,vsz,rss,comm -p $(pgrep -f "next.*frontend") 2>/dev/null | awk 'NR>1{print "PID=" $1 " ë©”ëª¨ë¦¬=" int($3/1024) "MB"}' || echo "í”„ë¡œì„¸ìŠ¤ ì •ë³´ ì—†ìŒ")
                echo "ğŸ“Š í”„ë¡ íŠ¸ì—”ë“œ í”„ë¡œì„¸ìŠ¤: $MEMORY_USAGE"
                break
              elif [ $i -eq 5 ]; then
                echo "âŒ í”„ë¡ íŠ¸ì—”ë“œ ì„œë¹„ìŠ¤ ì‹œì‘ ì‹¤íŒ¨"
                echo "ğŸ” í”„ë¡œì„¸ìŠ¤ ìƒíƒœ: $(ps aux | grep -E "next.*frontend" | grep -v grep || echo 'í”„ë¡œì„¸ìŠ¤ ì—†ìŒ')"
                exit 1
              else
                echo "â³ í”„ë¡ íŠ¸ì—”ë“œ ì¬ì‹œë„ $i/5... (10ì´ˆ ëŒ€ê¸°)"
                sleep 10
              fi
            done
          fi
          
          # ğŸ§¹ ë°±ì—… ì •ë¦¬ (ì„±ê³µ ì‹œ)
          if [ -d "/home/ubuntu/DailyMeal-backup" ]; then
            BACKUP_SIZE=$(du -sh /home/ubuntu/DailyMeal-backup | awk '{print $1}')
            rm -rf /home/ubuntu/DailyMeal-backup
            echo "ğŸ—‘ï¸ ì´ì „ ë°±ì—… ì •ë¦¬ ì™„ë£Œ (${BACKUP_SIZE} ê³µê°„ í™•ë³´)"
          fi
          
          # ğŸ“Š ìµœì¢… ì„±ëŠ¥ ë¦¬í¬íŠ¸
          log_resources "ë°°í¬ ì™„ë£Œ"
          echo "=========================================="
          echo "ğŸ‰ [$(date)] í”„ë¡œë•ì…˜ ë°°í¬ ì„±ê³µ!"
          echo "ğŸ“ˆ ì„±ëŠ¥ ìš”ì•½:"
          echo "  ğŸ”§ ë°±ì—”ë“œ: http://localhost:8000 (API ë¬¸ì„œ: /api-docs)"
          echo "  ğŸ¨ í”„ë¡ íŠ¸ì—”ë“œ: http://localhost:3000"
          echo "  ğŸ“Š ì´ Node.js í”„ë¡œì„¸ìŠ¤: $(ps aux | grep -E "node|next" | grep -v grep | wc -l)ê°œ"
          echo "  ğŸ’¾ ì´ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰: $(ps aux | grep -E "node|next" | grep -v grep | awk '{sum+=$6} END {print int(sum/1024) "MB"}')"
          echo "=========================================="
        
