# 2단계 식사 기록 시스템 - 완전 분리

## 📋 개요

사용자 경험을 개선하기 위해 식사 기록을 **2단계 프로세스**로 완전히 분리했습니다.

### 변경 전 (1단계 통합)
```
사진 + 제목 + 장소 + 가격 + 평점 + 메모 → 한 번에 입력
```
- 사진 촬영 후 모든 정보를 즉시 입력해야 함
- 식사 전에 평가를 해야 하는 비현실적인 UX
- 복잡한 폼으로 인한 사용자 이탈

### 변경 후 (2단계 분리)
```
1단계: 사진 + 자동 제목 → 즉시 저장
2단계: 평점 + 장소 + 가격 + 메모 → 나중에 평가
```
- 식사 전에 사진만 빠르게 촬영하고 저장
- 식사 후 여유있게 평가 추가
- 심플한 UX로 사용성 향상

## 🎯 주요 변경사항

### 1. 등록 페이지 단순화 (`/add`)

**파일**: `frontend/src/app/add/page.tsx`

#### 제거된 필드
- ❌ 장소 입력
- ❌ 가격 입력
- ❌ 평점 선택
- ❌ 메모 입력
- ❌ GPS 위치

#### 남은 필드
- ✅ 사진 업로드 (필수, 최대 5장)
- ✅ 제목 (자동 생성, 수정 가능)

#### 자동 제목 생성 로직
```typescript
const generateMealName = () => {
  const now = new Date()
  const month = now.getMonth() + 1
  const day = now.getDate()
  const hour = now.getHours()
  
  let mealType = ''
  if (hour >= 5 && hour < 11) {
    mealType = '아침'
  } else if (hour >= 11 && hour < 15) {
    mealType = '점심'
  } else if (hour >= 15 && hour < 18) {
    mealType = '간식'
  } else {
    mealType = '저녁'
  }
  
  return `${month}월 ${day}일 ${mealType}`
}
```

**예시**:
- 오전 8시: "10월 9일 아침"
- 오후 1시: "10월 9일 점심"
- 오후 4시: "10월 9일 간식"
- 오후 7시: "10월 9일 저녁"

#### UI 개선
- 큰 사진 업로드 영역
- 드래그 & 드롭 지원
- 미리보기 썸네일
- 사진 개별 삭제 기능
- 안내 메시지 추가

### 2. 평가 페이지 신규 생성 (`/meal/[id]/evaluate`)

**파일**: `frontend/src/app/meal/[id]/evaluate/page.tsx`

#### 포함 필드
- ⭐ 평점 (1-5점, 필수)
- 📍 장소 (선택)
- 💰 가격 (선택)
- 📝 메모 (선택, 200자)
- 🗺️ GPS 위치 (선택)

#### 주요 기능
1. **기존 데이터 로드**
   - 이미 평가한 경우 기존 값 표시
   - 수정 모드로 동작

2. **평점 이모지 피드백**
   ```
   5점: ⭐ 최고예요!
   4점: 😊 맛있어요
   3점: 🙂 괜찮아요
   2점: 😐 별로예요
   1점: 😞 최악이에요
   ```

3. **GPS 위치 가져오기**
   - 버튼 클릭으로 현재 위치 자동 입력
   - 역지오코딩으로 주소 변환
   - OpenStreetMap API 사용

4. **식사 정보 미리보기**
   - 상단에 사진 썸네일
   - 제목 및 등록 날짜 표시

### 3. 상세 페이지 개편 (`/meal/[id]`)

**파일**: `frontend/src/app/meal/[id]/page.tsx`

#### 평가 상태별 UI

**미평가 상태**:
```
┌─────────────────────────┐
│   [사진]                │
├─────────────────────────┤
│ 10월 9일 저녁           │
│ 2025.10.09 19:30        │
├─────────────────────────┤
│ ⭐ 아직 평가하지 않은    │
│    식사입니다            │
│                          │
│ [평가하기 버튼]          │
└─────────────────────────┘
```

**평가 완료 상태**:
```
┌─────────────────────────┐
│   [사진]                │
├─────────────────────────┤
│ 10월 9일 저녁           │
│ 2025.10.09 19:30        │
├─────────────────────────┤
│ 평가: ⭐⭐⭐⭐⭐       │
│ 📍 홍대 이탈리안        │
│ 💰 ₩18,000              │
│ 정말 맛있었어요!        │
│                          │
│ [평가 수정하기 버튼]     │
└─────────────────────────┘
```

#### 사진 갤러리
- 여러 장의 사진 지원
- 좌우 스와이프 (모바일)
- 인디케이터 점으로 현재 위치 표시

#### 삭제 기능
- 우측 상단 휴지통 아이콘
- 확인 팝업 표시

### 4. 카드 컴포넌트 업데이트

**파일**: `frontend/src/components/meal-card.tsx`

#### 평가 유무 표시
```typescript
{rating && rating > 0 ? (
  <div className="flex items-center">
    {/* 별점 표시 */}
  </div>
) : (
  <span className="text-xs text-gray-400">미평가</span>
)}
```

## 🔄 데이터 흐름

### 1단계: 사진 등록
```
사용자 → /add 페이지
     → 사진 촬영/선택
     → 자동 제목 생성
     → [저장] 버튼 클릭
     → POST /meal-records
        {
          name: "10월 9일 저녁",
          photos: [File, File, ...]
        }
     → DB 저장 (rating=null)
     → /feed로 리다이렉트
```

### 2단계: 평가 추가
```
사용자 → /feed에서 카드 클릭
     → /meal/[id] 상세 페이지
     → [평가하기] 버튼 클릭
     → /meal/[id]/evaluate 페이지
     → 평점, 장소, 가격, 메모 입력
     → [평가 저장하기] 버튼 클릭
     → PATCH /meal-records/[id]
        {
          rating: 5,
          location: "홍대 이탈리안",
          price: 18000,
          memo: "정말 맛있었어요!"
        }
     → DB 업데이트
     → /meal/[id]로 리다이렉트
```

### 수정 흐름
```
사용자 → /meal/[id] 상세 페이지
     → [평가 수정하기] 버튼 클릭
     → /meal/[id]/evaluate 페이지
     → 기존 데이터 로드 및 표시
     → 수정 후 저장
     → PATCH /meal-records/[id]
     → /meal/[id]로 리다이렉트
```

## 📱 사용자 시나리오

### 시나리오 1: 바쁜 점심 시간
```
1. 음식이 나옴 → 재빨리 사진 촬영 📸
2. [저장] 버튼만 클릭
3. 식사 시작 🍽️
4. (나중에) 여유있을 때 평가 추가
```

### 시나리오 2: 여유로운 저녁
```
1. 음식 사진 촬영 📸
2. [저장] 버튼 클릭
3. 식사 완료 후 즉시 평가
4. 별점, 메모 작성
```

### 시나리오 3: 과거 기록 정리
```
1. 피드에서 "미평가" 기록 확인
2. 기억을 되살려 평가 추가
3. 통계 데이터 정확도 향상
```

## 🎨 UI/UX 개선사항

### 등록 페이지
- ✅ 심플한 인터페이스 (필수만 표시)
- ✅ 큰 사진 업로드 영역
- ✅ 자동 제목으로 입력 부담 감소
- ✅ 명확한 안내 메시지

### 평가 페이지
- ✅ 식사 정보 미리보기 (상단)
- ✅ 큰 별점 선택 영역
- ✅ 이모지 피드백으로 직관성 향상
- ✅ GPS 위치 자동 입력
- ✅ 역지오코딩으로 주소 표시

### 상세 페이지
- ✅ 평가 상태 명확히 구분
- ✅ 미평가시 CTA 버튼 강조
- ✅ 사진 갤러리 지원
- ✅ 깔끔한 정보 레이아웃

## 📊 통계 및 영향

### 예상 효과
1. **사용자 등록 완료율 증가**
   - 기존: ~60% (복잡한 폼으로 이탈)
   - 개선: ~90% (사진만 있으면 완료)

2. **평가 참여율**
   - 즉시 평가: ~40%
   - 나중에 평가: ~30%
   - 총 평가율: ~70%

3. **평균 등록 시간**
   - 기존: ~2분 (모든 정보 입력)
   - 개선: ~30초 (사진만 촬영)

### 데이터 품질
- 미평가 기록도 가치 있는 데이터
- 사진 자체가 식습관 기록
- 나중에라도 평가 추가 가능

## 🔧 기술 구현

### Backend 변경 (최소)
```typescript
// Entity: rating을 nullable로 변경
@Column('int', { nullable: true })
rating: number;

// DTO: rating을 optional로 변경
@IsOptional()
@IsNumber()
rating?: number;
```

### Frontend 변경 (대규모)
```
✅ /add 페이지 완전 재작성
✅ /meal/[id]/evaluate 페이지 신규 생성
✅ /meal/[id] 페이지 클라이언트 컴포넌트로 전환
✅ meal-card 컴포넌트 미평가 상태 처리
✅ 타입 정의 업데이트
```

## 🚀 배포 가이드

### 1. 백엔드 배포
```bash
cd backend
npm run build
pm2 restart dailymeal-backend
```

### 2. 프론트엔드 배포
```bash
cd frontend
npm run build
pm2 restart dailymeal-frontend
```

### 3. 확인사항
- [ ] 사진 업로드 정상 작동
- [ ] 자동 제목 생성 확인
- [ ] 미평가 상태 표시
- [ ] 평가 페이지 접근
- [ ] 평가 저장 및 수정
- [ ] 카드에서 미평가 표시

## 📝 향후 개선 사항

### 단기 (1-2주)
1. **평가 알림**
   - 미평가 기록 3개 이상시 알림
   - "평가하지 않은 식사가 있어요!" 배너

2. **일괄 평가**
   - 미평가 목록 페이지
   - 스와이프로 빠른 평가

### 중기 (1개월)
1. **AI 자동 평가**
   - 사진 분석으로 음식 종류 자동 인식
   - 과거 평가 패턴 학습
   - 추천 평점 제시

2. **음성 메모**
   - 식사 중 음성으로 메모
   - STT로 텍스트 변환

### 장기 (3개월)
1. **소셜 기능 강화**
   - 친구의 미평가 기록 리마인드
   - 함께 평가하기

2. **게이미피케이션**
   - 평가 완료시 포인트 적립
   - 연속 평가 스트릭

## 🔗 관련 파일

### 신규 파일
- `frontend/src/app/add/page.tsx` (완전 재작성)
- `frontend/src/app/meal/[id]/evaluate/page.tsx` (신규)
- `frontend/src/app/meal/[id]/page.tsx` (클라이언트로 전환)

### 백업 파일
- `frontend/src/app/add/page_old.tsx`
- `frontend/src/app/meal/[id]/page_server.tsx`

### 수정 파일
- `frontend/src/components/meal-card.tsx`
- `frontend/src/types/index.ts`
- `backend/src/entities/meal-record.entity.ts`
- `backend/src/dto/meal-record.dto.ts`

## 📚 관련 문서
- [평가 시스템 업데이트](./RATING_OPTIONAL_UPDATE.md)
- [데이터베이스 문서](./DATABASE.md)
- [사용자 시나리오](./SCENARIOS.md)
